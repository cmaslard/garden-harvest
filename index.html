<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Anti-flash th√®me au tout d√©but -->
  <script>
  try{
    var t = localStorage.getItem('gh_theme');
    if(t) document.documentElement.setAttribute('data-theme', t);
    else {
      var h = new Date().getHours();
      document.documentElement.setAttribute('data-theme', (h>=7 && h<19)?'light':'dark');
    }
  }catch(e){}
  </script>

  <title>Garden Harvests ‚Äì Mini-app </title>

  <style>
    :root{
      color-scheme: light dark;
      --bg: #181818;
      --fg: #e5e7eb;
      --muted:#9ca3af;
      --card:#1f2937;
      --border:#374151;
      --primary:#40cdf2;
      --ok:#22c55e;
      --err:#ef4444;
    }

        /* 1) √âvite les d√©passements li√©s aux bordures/paddings */
    *, *::before, *::after { box-sizing: border-box; }

    /* 2) Permets aux enfants de la grille de r√©tr√©cir correctement (sinon overflow) */
    .row > *, .row3 > * { min-width: 0; }

    /* 3) Le <input type="date"> reste bien √† 100% sans ‚Äúmordre‚Äù √† droite */
    input[type="date"]{ width:100%; max-width:100%; }

    /* 4) (Optionnel) si un pixel d√©passe encore, on clippe proprement la carte */
    .card{ overflow: hidden; }

    /* Th√®me par d√©faut (sombre) + variante claire */
    html{ color-scheme: dark; }
    html[data-theme="light"]{
      color-scheme: light;
      --bg:#f8fafc;
      --fg:#0f172a;
      --muted:#475569;
      --card:#ffffff;
      --border:#e2e8f0;
      --primary:#0ea5e9;
      --ok:#16a34a;
      --err:#dc2626;
    }

    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      margin:0;
      background:var(--bg); color:var(--fg);
    }

    /* ===== Layout responsive ===== */
    .container{ max-width:1000px; margin:0 auto; padding:16px; }

    /* Header sticky (titre + switch de th√®me) */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:var(--bg);
      border-bottom:1px solid var(--border);
    }
    .topbar .wrap{
      max-width:1000px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 16px;
    }
    .topbar h1{ margin:0; font-size:1.35rem; letter-spacing:.2px; }

      /* Fix: bouton dark/light compact dans le header */
      .topbar #theme-toggle{
        width: auto;        /* override le width:100% global */
        flex: 0 0 auto;     /* ne s'√©tire pas */
        padding: .8rem;    /* compact */
        gap: 0;
        min-width: auto;
        border:1px solid var(--border);
        border-radius:999px;
        background:var(--card);
        color:var(--fg);
      }
      .topbar #theme-toggle svg{
        width:16px; height:16px;
        display:block;
      }
      /* Mobile : m√™me compact que le bouton th√®me */
            @media (max-width: 760px){
              .topbar #lang-toggle{
                padding: .35rem;
              }
            }

      /* Bouton langue : m√™me style que #theme-toggle */
      .topbar #lang-toggle{
      width: 44px;              /* fixe largeur = hauteur */
      height: 44px;
      padding: 0;               /* enl√®ve le padding interne */
      border: 1px solid var(--border);
      border-radius: 999px;     /* cercle parfait */
      background: var(--card);
      color: var(--fg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;          /* taille de l‚Äôemoji */
      line-height: 1;
    }
    @media (max-width: 760px){
      .topbar #lang-toggle{
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
    }

      

      /* (d√©j√† conseill√©) pour le titre qui prend la place et coupe en ‚Ä¶ si trop long */
      .topbar .wrap > * { min-width: 0; }
      .topbar h1{
        flex: 1 1 auto;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

    /* Cartes / formulaires / tableaux */
    .card{
      border:1px solid var(--border);
      border-radius:14px; padding:16px; margin:16px 0; background:var(--card);
    }
    label{font-size:.9rem;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{
      padding:.6rem;border:1px solid var(--border);border-radius:12px;width:100%;
      background:transparent;color:var(--fg)
    }
    input::placeholder{color:#6b7280}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-top:1px solid var(--border);text-align:left;vertical-align:top}

    /* Table responsive (scroll horizontal si petit √©cran) */
    .table-wrap{ width:100%; overflow-x:auto; border-radius:12px; }
    .table-wrap table{ min-width:680px; }

    /* Grilles */
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
    .muted{color:var(--muted);font-size:.92rem}
    .right{display:flex;justify-content:flex-end;gap:.6rem;align-items:center}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:.8rem;color:var(--muted)}
    .hide{display:none}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:.35rem .8rem;border:1px solid var(--border);border-radius:999px;background:transparent}
    .tab.active{border-color:var(--primary);color:var(--primary)}
    .btn-primary{border-color:var(--primary);color:var(--primary)}
    .msg-ok{color:var(--ok)} .msg-err{color:var(--err)}

    /* ===== Mobile ===== */
@media (max-width: 760px){
  .container{ padding:12px; }
  .topbar .wrap{ padding:8px 12px; }
  .topbar h1{ font-size:1.1rem; }
  .row, .row3{ grid-template-columns:1fr; }
  .right{ justify-content:flex-start; gap:.5rem; flex-wrap:wrap; }
  th, td{ padding:.6rem; }
  .topbar #theme-toggle{
    padding: .35rem;      
    min-width: auto;      
    line-height: 0;       
    border-radius: 999px;
  }
  .topbar #theme-toggle svg{
    width: 14px;
    height: 14px;
  }
} 
  </style>
</head>

<body>
  <!-- Header sticky -->
  <header class="topbar">
    <div class="wrap">
      <h1>Garden Harvests ‚Äì Data base</h1>
      <button id="theme-toggle" aria-label="Changer de th√®me" title="Changer de th√®me"></button>
      <button id="lang-toggle" class="btn" title="Language">üåê</button>
    </div>
  </header>

  <main class="container">
    <!-- Auth -->
    <div id="auth" class="card">
      <h2>Connexion</h2>
      <div class="tabs">
        <button id="tab-pass" class="tab active">Email + mot de passe</button>
        <button id="tab-magic" class="tab">Magic link</button>
      </div>
      
      <!-- Email + password -->
      <div id="pane-pass">
        <div class="row">
          <div>
            <label>Email</label>
            <input id="email-pass" type="email" placeholder="toi@example.com" />
          </div>
          <div>
            <label>Mot de passe</label>
            <input id="pwd-pass" type="password" placeholder="******" />
          </div>
        </div>
        <div class="right" style="margin-top:12px">
          <button id="btn-signin" class="btn-primary">Se connecter</button>
          <button id="btn-signup">Cr√©er un compte</button>
        </div>
        <p class="muted" style="margin-top:8px">Apr√®s inscription il peut √™tre n√©cessaire de confirmer l‚Äôemail selon tes param√®tres Supabase.</p>
        <p id="auth-msg-pass" class="muted"></p>
      </div>
    </div>
    
    <!-- Magic link -->
    <div id="pane-magic" class="hide">
      <p class="muted">Entre ton email pour recevoir un lien magique.</p>
      <div class="row">
        <input id="email-magic" type="email" placeholder="toi@example.com" />
        <button id="send-link" class="btn-primary">Envoyer le lien</button>
      </div>
      <p id="auth-msg-magic" class="muted"></p>
    </div>

    <!-- App -->
    <div id="app" class="hide">
      <div class="card" id="whoami">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <div>
            Connect√© : <span id="who"></span>
            <span class="pill">RLS actif</span>
          </div>
          <div class="right">
            <button id="reload">Rafra√Æchir</button>
            <button id="signout">Se d√©connecter</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Ajouter une r√©colte</h2>
        <div class="row3">
          <div>
            <label>Produit</label>
            <select id="product" required></select>
          </div>
          <div>
            <label>Lieu</label>
            <select id="location" required></select>
          </div>
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
        </div>
        <div class="row3" style="margin-top:1rem">
          <div>
            <label>Quantit√© (<span id="unit">‚Äì</span>)</label>
            <input id="qty" type="number" step="0.01" min="0" required/>
          </div>
          <div>
            <label>Note</label>
            <input id="note" placeholder="rang, commentaire‚Ä¶" />
          </div>
          <div style="align-self:end">
            <button id="add" class="btn-primary">Ajouter</button>
          </div>
        </div>
        <p id="add-msg" class="muted"></p>
      </div>

      <div class="card">
        <h2>Derni√®res entr√©es</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Par</th>
                <th>Produit</th>
                <th>Vari√©t√©</th>
                <th>Qt√©</th>
                <th>Unit√©</th>
                <th>Lieu</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <p id="rows-msg" class="muted"></p>
      </div>
    </div>
  </main>

  <script type="module">
// ==== i18n UI statique ====
const I18N = {
  fr: {
    app_title: "Garden Harvests ‚Äì Base de donn√©es",
    auth_title: "Connexion",
    tab_pass: "Email + mot de passe",
    tab_magic: "Magic link",
    email_label: "Email",
    pwd_label: "Mot de passe",
    signin: "Se connecter",
    signup: "Cr√©er un compte",
    signup_hint: "Apr√®s inscription il peut √™tre n√©cessaire de confirmer l‚Äôemail selon tes param√®tres Supabase.",
    magic_hint: "Entre ton email pour recevoir un lien magique.",
    magic_send: "Envoyer le lien",
    connected: "Connect√© : ",
    rls: "RLS actif",
    refresh: "Rafra√Æchir",
    signout: "Se d√©connecter",
    add_h2: "Ajouter une r√©colte",
    product_label: "Produit",
    location_label: "Lieu",
    date_label: "Date",
    qty_label: "Quantit√©",
    note_label: "Note",
    note_ph: "rang, commentaire‚Ä¶",
    add_btn: "Ajouter",
    last_h2: "Derni√®res entr√©es",
    th_date: "Date",
    th_by: "Par",
    th_product: "Produit",
    th_variety: "Vari√©t√©",
    th_qty: "Qt√©",
    th_unit: "Unit√©",
    th_loc: "Lieu",
    th_note: "Note",
    choose_product: "‚Äî choisir ‚Äî",
    choose_none: "‚Äî aucun ‚Äî",
    choose_product_err: "Choisis un produit.",
    choose_loc_err: "Choisis un lieu.",
    choose_date_err: "Choisis une date.",
    enter_qty_err: "Entre une quantit√©.",
    added_ok: "R√©colte ajout√©e.",
    rows_empty: "Aucune ligne pour le moment.",
    products_err_hint: 'Erreur produits : '
  },
  en: {
    app_title: "Garden Harvests ‚Äì Database",
    auth_title: "Sign in",
    tab_pass: "Email + password",
    tab_magic: "Magic link",
    email_label: "Email",
    pwd_label: "Password",
    signin: "Sign in",
    signup: "Create account",
    signup_hint: "After sign-up you may need to confirm your email depending on Supabase settings.",
    magic_hint: "Enter your email to receive a magic link.",
    magic_send: "Send link",
    connected: "Signed in: ",
    rls: "RLS on",
    refresh: "Refresh",
    signout: "Sign out",
    add_h2: "Add a harvest",
    product_label: "Product",
    location_label: "Location",
    date_label: "Date",
    qty_label: "Quantity",
    note_label: "Note",
    note_ph: "row, comment‚Ä¶",
    add_btn: "Add",
    last_h2: "Latest entries",
    th_date: "Date",
    th_by: "By",
    th_product: "Product",
    th_variety: "Variety",
    th_qty: "Qty",
    th_unit: "Unit",
    th_loc: "Location",
    th_note: "Note",
    choose_product: "‚Äî choose ‚Äî",
    choose_none: "‚Äî none ‚Äî",
    choose_product_err: "Pick a product.",
    choose_loc_err: "Pick a location.",
    choose_date_err: "Pick a date.",
    enter_qty_err: "Enter a quantity.",
    added_ok: "Harvest added.",
    rows_empty: "No rows yet.",
    products_err_hint: 'Products error: '
  }
};

function applyI18n(){
  const t = I18N[curLang] || I18N.fr;

  // titres / labels / boutons
  document.title = t.app_title;
  const h1 = document.querySelector('.topbar h1'); if (h1) h1.textContent = t.app_title;

  const setTxt = (sel, val) => { const el = document.querySelector(sel); if (el) el.textContent = val; };
  setTxt('#auth h2', t.auth_title);
  setTxt('#tab-pass', t.tab_pass);
  setTxt('#tab-magic', t.tab_magic);
  setTxt('label[for="email-pass"]', t.email_label);
  setTxt('label[for="pwd-pass"]', t.pwd_label);
  setTxt('#btn-signin', t.signin);
  setTxt('#btn-signup', t.signup);
  setTxt('#pane-pass .muted', t.signup_hint);
  setTxt('#pane-magic .muted', t.magic_hint);
  setTxt('#send-link', t.magic_send);

  // whoami line parts
  const whoPrefix = document.querySelector('#whoami .card div div:first-child');
  if (whoPrefix) {
    const whoSpan = document.getElementById('who');
    whoPrefix.childNodes[0].nodeValue = t.connected; // remplace le texte fixe avant <span id="who">
    const rls = whoPrefix.querySelector('.pill'); if (rls) rls.textContent = t.rls;
  }
  setTxt('#reload', t.refresh);
  setTxt('#signout', t.signout);

  setTxt('h2:nth-of-type(2)', t.add_h2); // le 2e <h2> dans la page (section ajout)
  // labels du formulaire
  document.querySelectorAll('label').forEach(lbl => {
    const htmlFor = lbl.getAttribute('for');
    if (htmlFor === 'product') lbl.textContent = t.product_label;
    if (htmlFor === 'location') lbl.textContent = t.location_label;
    if (htmlFor === 'date') lbl.textContent = t.date_label;
    if (htmlFor === 'qty') lbl.innerHTML = `${t.qty_label} (<span id="unit">‚Äì</span>)`;
    if (htmlFor === 'note') lbl.textContent = t.note_label;
  });
  const note = document.getElementById('note'); if (note) note.placeholder = t.note_ph;
  setTxt('#add', t.add_btn);

  // bloc "Derni√®res entr√©es"
  const lastH2 = document.querySelectorAll('h2')[2]; if (lastH2) lastH2.textContent = t.last_h2;
  const th = document.querySelectorAll('thead th');
  if (th.length >= 8){
    th[0].textContent = t.th_date;
    th[1].textContent = t.th_by;
    th[2].textContent = t.th_product;
    th[3].textContent = t.th_variety;
    th[4].textContent = t.th_qty;
    th[5].textContent = t.th_unit;
    th[6].textContent = t.th_loc;
    th[7].textContent = t.th_note;
  }

  // placeholders des selects (seront utilis√©s dans loadProducts/loadLocations)
  window.__i18n_choose_product = t.choose_product;
  window.__i18n_choose_none = t.choose_none;

  // messages
  window.__i18n_err_pick_product = t.choose_product_err;
  window.__i18n_err_pick_loc = t.choose_loc_err;
  window.__i18n_err_pick_date = t.choose_date_err;
  window.__i18n_err_enter_qty = t.enter_qty_err;
  window.__i18n_added_ok = t.added_ok;
  window.__i18n_rows_empty = t.rows_empty;
  window.__i18n_products_err_hint = t.products_err_hint;
}

    // === THEME ===
    const THEME_KEY = 'gh_theme'; // 'light' | 'dark' ; absent => auto (par heure)

    const sunSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"></circle>
      <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
    </svg>`;
    const moonSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1111.21 3
               7 7 0 0021 12.79z"/>
    </svg>`;

    function themeByHour(d = new Date()){
      const h = d.getHours();
      // clair de 7h √† 19h, sombre sinon
      return (h >= 7 && h < 19) ? 'light' : 'dark';
    }

    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      const btn = document.getElementById('theme-toggle');
      if (btn) btn.innerHTML = (t === 'dark') ? moonSVG : sunSVG;
    }

    function scheduleAuto(){
      const now = new Date();
      const h = now.getHours();
      const next = (h < 7)
        ? new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 0, 0)
        : (h < 19)
          ? new Date(now.getFullYear(), now.getMonth(), now.getDate(), 19, 0, 0)
          : new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 7, 0, 0);
      setTimeout(() => { applyTheme(themeByHour()); scheduleAuto(); }, Math.max(60_000, next - now));
    }

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY); // 'light' | 'dark' | null
      const t = saved || themeByHour();
      applyTheme(t);
      if (!saved) scheduleAuto(); // mode auto si pas de pr√©f√©rence sauvegard√©e
    }

    initTheme();

    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme');
      const next = (cur === 'dark') ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    });
    // Clic droit: retour au mode auto (selon l‚Äôheure)
    themeBtn.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      localStorage.removeItem(THEME_KEY);
      applyTheme(themeByHour());
      scheduleAuto();
    });

    // === SUPABASE APP ===
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ==== Projet Supabase (fix√©) ====
    const SUPABASE_URL = "https://xygczpwgowmmarfkwdbc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5Z2N6cHdnb3dtbWFyZmt3ZGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTUwNDYsImV4cCI6MjA3MjA3MTA0Nn0.euY43Bd9gJW4y2qvxjwAZqrP6RPQXmGwcpD1H1Qx_pg";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // IMPORTANT : on cible le sch√©ma 'garden' (ajoute-le dans Settings ‚Üí API ‚Üí Exposed Schemas)
    const db = sb.schema('garden');

    // baseRedirect = URL du dossier courant (ex: https://cmaslard.xyz/garden-harvest/)
    const baseRedirect = (() => {
      const base = location.origin + location.pathname.replace(/[^/]*$/, '');
      return base.endsWith('/') ? base : base + '/';
    })();

    // UI elems
    const authCard  = document.getElementById('auth');
    const appCard   = document.getElementById('app');
    const whoSpan   = document.getElementById('who');
    const signout   = document.getElementById('signout');
    const reloadBtn = document.getElementById('reload');

    // Tabs
    const tabMagic  = document.getElementById('tab-magic');
    const tabPass   = document.getElementById('tab-pass');
    const paneMagic = document.getElementById('pane-magic');
    const panePass  = document.getElementById('pane-pass');

    tabMagic.onclick = () => { tabMagic.classList.add('active'); tabPass.classList.remove('active'); paneMagic.classList.remove('hide'); panePass.classList.add('hide'); };
    tabPass.onclick  = () => { tabPass.classList.add('active');  tabMagic.classList.remove('active'); panePass.classList.remove('hide'); paneMagic.classList.add('hide'); };

    // Magic link
    const emailMagic = document.getElementById('email-magic');
    const sendBtn    = document.getElementById('send-link');
    const msgMagic   = document.getElementById('auth-msg-magic');

    sendBtn.onclick = async () => {
      msgMagic.textContent = 'Envoi‚Ä¶';
      const { error } = await sb.auth.signInWithOtp({
        email: (emailMagic.value || '').trim(),
        options: { emailRedirectTo: baseRedirect }
      });
      msgMagic.className = 'muted ' + (error ? 'msg-err' : 'msg-ok');
      msgMagic.textContent = error ? ('Erreur : ' + error.message) : 'Lien envoy√© ! V√©rifie tes emails.';
    };

    // Password auth
    const emailPass = document.getElementById('email-pass');
    const pwdPass   = document.getElementById('pwd-pass');
    const btnSignin = document.getElementById('btn-signin');
    const btnSignup = document.getElementById('btn-signup');
    const msgPass   = document.getElementById('auth-msg-pass');

    btnSignin.onclick = async () => {
      msgPass.textContent = 'Connexion‚Ä¶';
      const { error } = await sb.auth.signInWithPassword({
        email: (emailPass.value || '').trim(),
        password: pwdPass.value || ''
      });
      msgPass.className = 'muted ' + (error ? 'msg-err' : 'msg-ok');
      msgPass.textContent = error ? ('Erreur : ' + error.message) : 'Connect√© !';
      if (!error) await afterAuth();
    };

    btnSignup.onclick = async () => {
      msgPass.textContent = 'Cr√©ation du compte‚Ä¶';
      const { data, error } = await sb.auth.signUp({
        email: (emailPass.value || '').trim(),
        password: pwdPass.value || '',
        options: { emailRedirectTo: baseRedirect }
      });
      msgPass.className = 'muted ' + (error ? 'msg-err' : 'msg-ok');
      msgPass.textContent = error
        ? ('Erreur : ' + error.message)
        : (data?.user?.identities?.length ? 'Compte cr√©√© ! Connecte-toi.' : 'V√©rifie ton email pour confirmer le compte.');
    };

    // Session
    sb.auth.getSession().then(({ data }) => toggleUI(!!data.session));
    sb.auth.onAuthStateChange((_e, s) => {
  toggleUI(!!s);
  if (s?.user) loadLanguageAndRenderBtn();   // ‚Üê charge le drapeau apr√®s connexion
});

    function toggleUI(signedIn){
      if (signedIn){
        authCard.classList.add('hide');
        appCard.classList.remove('hide');
        afterAuth();
      } else {
        authCard.classList.remove('hide');
        appCard.classList.add('hide');
      }
    }

    async function afterAuth(){
      const { data: { user } } = await sb.auth.getUser();
      whoSpan.textContent = user?.email || '(session)';
      await loadLanguageAndRenderBtn();   // ‚Üê add this line
      applyI18n();  
      await refreshAll();
    }

    signout.onclick = async () => { await sb.auth.signOut(); location.href = baseRedirect; };
    reloadBtn.onclick = () => { refreshAll(); };

    // App elems
    const selProduct= document.getElementById('product');
    const selLoc    = document.getElementById('location');
    const dateInp   = document.getElementById('date');
    const qtyInp    = document.getElementById('qty');
    const noteInp   = document.getElementById('note');
    const addBtn    = document.getElementById('add');
    const unitSpan  = document.getElementById('unit');
    const addMsg    = document.getElementById('add-msg');
    const rowsBody  = document.getElementById('rows');
    const rowsMsg   = document.getElementById('rows-msg');

    // === Single language toggle button ‚Üí only updates DB (garden.profiles.language) ===
    const langBtn = document.getElementById('lang-toggle');
    let curLang = 'fr'; // default if none in DB

    function renderLangBtn() {
      if (!langBtn) return;
      if (curLang === 'fr') {
        langBtn.textContent = 'üá´üá∑';
        langBtn.title = 'Fran√ßais ‚Äî cliquer pour passer en anglais';
        langBtn.setAttribute('aria-label', 'Switch language to English');
      } else {
        langBtn.textContent = 'üá¨üáß';
        langBtn.title = 'English ‚Äî click to switch to French';
        langBtn.setAttribute('aria-label', 'Passer la langue en fran√ßais');
      }
    }
      // Read from DB then render the button
      async function loadLanguageAndRenderBtn() {
  if (!langBtn) return;
  const { data: { user } } = await sb.auth.getUser();
  if (!user) { langBtn.classList.add('hide'); return; }
  langBtn.classList.remove('hide');

  const { data, error } = await db
    .from('profiles')
    .select('language')
    .eq('user_id', user.id)
    .maybeSingle();

  if (error) console.warn('profiles select error:', error);
  curLang = (data?.language === 'en' || data?.language === 'fr') ? data.language : 'fr';
  renderLangBtn();
}

function makeUsername(user) {
  // Essaie: username saisi (si un jour tu l'ajoutes), sinon local-part de l'email, sinon d√©but de l‚Äôuid
  const fromEmail = (user?.email || '').split('@')[0].replace(/[^a-z0-9._-]/gi, '').slice(0, 24);
  if (fromEmail) return fromEmail;
  return ('user_' + (user?.id || '').replace(/-/g, '').slice(0, 12) || ('user_' + Math.random().toString(36).slice(2, 10)));
}

      // Toggle + upsert to DB (no UI text change yet, only DB)
if (langBtn) {
  langBtn.onclick = async () => {
    try {
      const next = (curLang === 'fr') ? 'en' : 'fr';
      langBtn.disabled = true;

      const { data: { user } } = await sb.auth.getUser();
      if (!user) return alert('Not signed in');

      // 1) Le profil existe ?
      const { data: existing, error: selErr } = await db
        .from('profiles')
        .select('user_id')
        .eq('user_id', user.id)
        .maybeSingle();
      if (selErr) throw selErr;

      if (existing) {
        // 2a) Il existe ‚Üí on met √† jour UNIQUEMENT la langue
        const { error: updErr } = await db
          .from('profiles')
          .update({ language: next })
          .eq('user_id', user.id);
        if (updErr) throw updErr;
      } else {
        // 2b) N‚Äôexiste pas ‚Üí on ins√®re (avec username pour respecter NOT NULL)
        let profile = { user_id: user.id, language: next, username: makeUsername(user) };
        let { error: insErr } = await db.from('profiles').insert(profile);
        if (insErr && /duplicate key value.*username/i.test(insErr.message)) {
          profile.username = profile.username + '_' + Math.random().toString(36).slice(2, 6);
          ({ error: insErr } = await db.from('profiles').insert(profile));
        }
        if (insErr) throw insErr;
      }

      curLang = next;
      renderLangBtn();
      applyI18n();
      await refreshAll();
    } catch (e) {
      alert('Error saving language: ' + (e.message || e));
      console.error(e);
    } finally {
      langBtn.disabled = false;
    }
  };
}

    // App logic
    async function refreshAll(){
      // date par d√©faut = aujourd‚Äôhui
      if (!dateInp.value) dateInp.valueAsDate = new Date();
      selProduct.onchange = () => {
        const opt = selProduct.selectedOptions[0];
        unitSpan.textContent = opt?.dataset.unit || '‚Äì';
      };
      await Promise.all([loadProducts(), loadLocations(), refreshRows()]);
      addBtn.onclick = onAdd;
    }

    async function loadProducts(){
      const { data, error } = await db.from('products').select('id,name,variety,unit_harvest').order('name');
      if (error){
        rowsMsg.textContent = 'Erreur produits : ' + error.message + ' ‚Äî V√©rifie "Exposed Schemas" (Settings ‚Üí API) contient "garden".';
        return;
      }
      selProduct.innerHTML = '<option value="">‚Äî choisir ‚Äî</option>' +
        data.map(p => `<option value="${p.id}" data-unit="${p.unit_harvest}">${p.name}${p.variety?` ‚Äî ${p.variety}`:''}</option>`).join('');
      unitSpan.textContent = '‚Äì';
    }

    async function loadLocations(){
      const { data, error } = await db.from('locations').select('id,name').order('name');
      if (error){
        // pas bloquant pour l'ajout sans lieu
        return;
      }
      selLoc.innerHTML = '<option value="">‚Äî aucun ‚Äî</option>' +
        data.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
    }

    async function refreshRows(){
      const { data, error } = await db.from('harvests_view').select('*').limit(100);
      if (error){
        rowsMsg.textContent = 'Erreur lecture : ' + error.message;
        rowsBody.innerHTML = '';
        return;
      }
      rowsBody.innerHTML = data.map(r => `
        <tr>
          <td>${r.harvest_date ?? ''}</td>
          <td>${r.created_by_name ?? ''}</td>
          <td>${r.product_name ?? ''}</td>
          <td>${r.variety ?? ''}</td>
          <td>${r.quantity ?? ''}</td>
          <td>${r.harvest_unit ?? ''}</td>
          <td>${r.location_name ?? ''}</td>
          <td>${r.note ?? ''}</td>
        </tr>
      `).join('');
      rowsMsg.textContent = data.length ? '' : 'Aucune ligne pour le moment.';
    }

    async function onAdd(){
      addMsg.textContent = '';
      const productId  = selProduct.value ? Number(selProduct.value) : null;
      if (!productId){ addMsg.textContent = 'Choisis un produit.'; return; }
      const locationId = selLoc.value ? Number(selLoc.value) : null;
      if (!locationId){ addMsg.textContent = 'Choisis un lieu.'; return; }
      const dateVal = dateInp.value;
      if (!dateVal){ addMsg.textContent = 'Choisis une date.'; return; }
      const qty = (qtyInp.value === '' ? NaN : Number(qtyInp.value));
      if (!(qty >= 0)){ addMsg.textContent = 'Entre une quantit√©.'; return; }
      const payload = {
        product_id:  productId,
        location_id: locationId,
        harvest_date: dateVal,
        quantity:    qty,
        note:        noteInp.value || null,
      };
      const { error } = await db.from('harvests').insert(payload);
      if (error){ addMsg.className='muted msg-err'; addMsg.textContent = error.message; return; }
      addMsg.className='muted msg-ok'; addMsg.textContent = 'R√©colte ajout√©e.';
      qtyInp.value=''; noteInp.value='';
      await refreshRows();
    }
  </script>
</body>
</html>